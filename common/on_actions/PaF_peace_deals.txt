on_actions = {
	on_capitulation = {
		effect = {
			set_global_flag = announce_peace
			FROM = {
				save_global_event_target_as = winning_country
			} 
			ROOT = {
				save_global_event_target_as = losing_country
			}
			if = {
				limit = {
					event_target:losing_country = {
						any_allied_country = {
							has_war_together_with = event_target:losing_country
						}
					}
				}
				set_global_flag = losing_country_multiple
			}

			if = {
				limit = {
					event_target:winning_country = {
						any_allied_country = {
							has_war_together_with = event_target:winning_country
						}
					}
				}
				set_global_flag = winning_country_multiple
			}
			add_to_variable = { global.peace_popup_dirty = 1 }			
				if = {
					limit = {
						ROOT = {
							original_tag = BOH
						}
						FROM = {
							OR = {
								original_tag = UMN
								original_tag = TRN
							}
						}
					}

					FROM = {
						white_peace = ROOT
						UMN = {
							transfer_state = 505
							transfer_state = 824
						}
						TRN = {
							transfer_state = 495
							transfer_state = 823
						}
					}
					log = "[GetDateText]: UMN and TRN beaten [ROOT.GetName]"
					set_global_flag = skip_default_capitulation
				}
				if = {
					limit = {
						ROOT = {
							original_tag = WDW
						}
						FROM = {
							OR = {
								original_tag = HOR
								original_tag = OSW
							}
						}
					}

					FROM = {
						white_peace = ROOT
						HOR = {
							transfer_state = 801
							transfer_state = 515
							transfer_state = 594
						}
						OSW = {
							transfer_state = 800
						}
					}
					log = "[GetDateText]: HOR and OSW beaten [ROOT.GetName]"
					set_global_flag = skip_default_capitulation
				}
			if = {
					limit = {
						ROOT = {
							original_tag = TOU
						}
						FROM = {
							OR = {
								original_tag = EKS
								original_tag = KGH
							}
						}
					}

					FROM = {
						white_peace = ROOT
						if = { limit = { country_exists = EKS } 
							annex_country = {
							target = TOU
							transfer_troops = yes
							}
						}
						if = { limit = { country_exists = KGH } 
							annex_country = {
							target = TOU
							transfer_troops = yes
							}
						}
						TOU = {
							transfer_state = 728
							transfer_state = 401
							transfer_state = 407
						}
					}
					log = "[GetDateText]: Touristenkrieg ended"
					set_global_flag = skip_default_capitulation
			}
			if = {
					limit = {
						ROOT = {
							original_tag = KES
						}
						FROM = {
							OR = {
								original_tag = CAL
								original_tag = FEL
							}
						}
					}

					FROM = {
						white_peace = ROOT
						CAL = {
							transfer_state = 342
							transfer_state = 359
							transfer_state = 337
							transfer_state = 335
							transfer_state = 311
							transfer_state = 851
							transfer_state = 285
						}
						FEL = {
							transfer_state = 257
							transfer_state = 843
							transfer_state = 271
							transfer_state = 298
							transfer_state = 320
							transfer_state = 274
							transfer_state = 292
						}
					}
					log = "[GetDateText]: Kesselring ded"
					set_global_flag = skip_default_capitulation
				}
			if = {
				limit = {
					ROOT = {
						original_tag = GFL
					}
					FROM = {
						original_tag = ZHP
					}
				}
				FROM = {
					country_event = {
						id = zhp.21
					}
				}
				log = "[GetDateText]: ZHP whacked greys"
			}
			if = {
				limit = {
					ROOT = {
						original_tag = ZHP
					}
					FROM = {
						original_tag = GFL
					}
				}
				ZHP_return_characters = yes
				ROOT = {
					white_peace = FROM
					annex_country = {
						target = FROM
						transfer_troops = yes
					}
				}
				set_politics = {
					ruling_party = postpolonism
				}
				set_country_leader_ideology = scout_system_subtype
				set_global_flag = ZHP_civil_war_lost
				set_global_flag = skip_default_capitulation
				log = "[GetDateText]: ZHP lost to greys"
			}
			if = {
				limit = {
					ROOT = {
						original_tag = ZHP
					}
					FROM = {
						original_tag = ZHR
					}
				}
				ZHP_return_characters = yes
				ROOT = {
					white_peace = FROM
					annex_country = {
						target = FROM
						transfer_troops = yes
					}
				}
				set_politics = {
					ruling_party = paternal_conservatism
				}
				set_country_leader_ideology = paternal_conservatism_subtype
				set_global_flag = ZHP_civil_war_lost
				set_global_flag = skip_default_capitulation
				log = "[GetDateText]: ZHP lost to archbishop"
			}
			if = {	
				limit = {
					OR = {
						ROOT = { is_in_faction = no }
						ROOT = {
							all_allied_country = {
								has_capitulated = yes
							}
						}
					}
				}
				FROM = {
					log = "Before: [?ROOT.num_owned_states]"
					every_controlled_state = {
						limit = {
							is_owned_by = ROOT
						}
						transfer_state_to = FROM
					}
					log = "[FROM.GetName] takes states from [ROOT.GetName]"
					every_other_country = {
						limit = {
							has_war_together_with = FROM
						}
						every_controlled_state = {
							limit = {
								is_owned_by = ROOT
							}
							transfer_state_to = PREV
						}
						log = "[THIS.GetName] (figthing together with [FROM.GetName]) takes states from [ROOT.GetName]"
					}
					every_other_country = {
						limit = {
							has_war_with = ROOT
						}
						every_controlled_state = {
							limit = {
								is_owned_by = ROOT
							}
							transfer_state_to = PREV
						}
						log = "[THIS.GetName] takes states from [ROOT.GetName]"
					}
					log = "[FROM.GetName] killed [ROOT.GetName]"
					log = "After: [?ROOT.num_owned_states] (controlled [?ROOT.num_of_controlled_states])"
					if = {
						limit = {
							or = {
								ROOT = {
									num_of_controlled_states > 0
								}
								#ROOT = {
									#num_owned_states > 0
								#}
							}
						}
						log = "[ROOT.GetName] refuse to die!"
						annex_country = {
							target = ROOT
							transfer_troops = no
						}
					}
					#white_peace = ROOT
					#annex_country = {
						#target = ROOT
						#transfer_troops = no
					#}
				}
				set_global_flag = war_won
				set_global_flag = skip_default_capitulation
			}
		}
	}
}
