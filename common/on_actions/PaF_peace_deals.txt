on_actions = {
	on_capitulation_immediate = {
		effect = {
			log = "[GetDateText]: [ROOT.GetName] ([?ROOT.casualties_k]) was just capped by [FROM.GetName] ([?FROM.casualties_k])"
			if = {
				limit = {
					ROOT = {
						is_in_faction = yes
					}
				}
				if = {
					limit = {
						is_faction_leader = no
					}
					leave_faction = yes
				}
				else = {
					every_country = {
						limit = {
							is_in_faction_with = ROOT
						}
						ROOT = {
							remove_from_faction = this
						}
					}
				}
			}
			FROM = {
				if = {
					limit = {
						NOT = {
							original_tag = ROS
							original_tag = UPA
							original_tag = UHR
						}
					}
					add_to_variable = {
						global.deadPolacksFromPastWars = this.casualties_k
					}
				}
			}
			if = {
				limit = {
					ROOT = {
						NOT = {
							original_tag = ROS
							original_tag = UPA
							original_tag = UHR
						}
					}
				}
				if = {
					limit = {
						has_variable = global.deadPolacksFromDeadNations
					}
					add_to_variable = {
						global.deadPolacksFromDeadNations = ROOT.casualties_k
					}
					else = {
						set_variable = {
							global.deadPolacksFromDeadNations = ROOT.casualties_k
						}
					}
					
				}
				add_to_variable = {
					global.deadPolacksFromDeadNations = ROOT.casualtiesFromEvents
				}
			}
			
			if = {
				limit = {
					ROOT = {
						has_country_flag = importing_energy
					}
				}
				BBW = {
					add_offsite_building = {
						level = -1
						type = industrial_complex
					}
					subtract_from_variable = {energy_exported = 750}
				}
			}
			if = {
				limit = {
					ROOT = {
						or = {
							original_tag = KRS
							original_tag = SAP
							original_tag = WML
							original_tag = ZHP
							original_tag = ZYD
						}
					}
				}
				if = {
					limit = {
						not ={
							BBW = {
								has_variable = BBW_pre_blackout_nerf
							}
							
						}
					}
					BBW = {
						set_variable = {BBW_pre_blackout_nerf = 0.9}
					}
					
				}
				else = {
					BBW = {
						add_to_variable = {BBW_pre_blackout_nerf = -0.1}
					}
				}
				BBW = {
					calculate_energy_balance = yes
				}
			}
#			set_temp_variable = {popularity_to_add = ROOT.party_popularity@ruling_party}
#			set_temp_variable = {ideology_to_add = ROOT.current_party_ideology_group}
#			divide_temp_variable = { popularity_to_add = 10}
#			FROM = {
#				add_popularity = {
#					ideology = reactionary
#					popularity = popularity_to_add
#				}
#			}
#			log = "[GetDateText]: Added [?popularity_to_add] of [ROOT.GetRulingIdeology]"
			
			every_other_country = {
				limit = {
					NOT = {
						original_tag = FROM
						original_tag = ROS
						original_tag = UPA
						original_tag = UHR
					}
					has_war_with = ROOT
				}
				add_to_array = {
					global.allies = This
				}
				add_to_variable = {
					global.deadPolacksFromPastWars = this.casualties_k
				}
				log = "[GetDateText]: Also ran: [THIS.GetName] ([?this.casualties_k])"
			}
		}
	}
	on_capitulation = {
		effect = {
			set_global_flag = announce_peace
			FROM = {
				save_global_event_target_as = winning_country
			} 
			ROOT = {
				save_global_event_target_as = losing_country
			}
			if = {
				limit = {
					event_target:losing_country = {
						any_allied_country = {
							has_war_together_with = event_target:losing_country
						}
					}
				}
				set_global_flag = losing_country_multiple
			}

			if = {
				limit = {
					event_target:winning_country = {
						any_allied_country = {
							has_war_together_with = event_target:winning_country
						}
					}
				}
				set_global_flag = winning_country_multiple
			}
			add_to_variable = { global.peace_popup_dirty = 1 }			
				if = {
					limit = {
						ROOT = {
							original_tag = BOH
							
						}
						FROM = {
							OR = {
								original_tag = UMN
								original_tag = TRN
							}
						}
					}

					FROM = {
						white_peace = ROOT
						UMN = {
							transfer_state = 505
							transfer_state = 824
						}
						TRN = {
							transfer_state = 495
							transfer_state = 823
						}
					}
					log = "[GetDateText]: UMN and TRN beaten [ROOT.GetName]"
					set_global_flag = skip_default_capitulation
				}
				if = {
					limit = {
						ROOT = {
							original_tag = WDW
						}
						FROM = {
							OR = {
								original_tag = HOR
								original_tag = OSW
							}
						}
					}

					FROM = {
						white_peace = ROOT
						if = {
							limit = {
								country_exists = HOR
							}
							HOR = {
								transfer_state = 801
								transfer_state = 515
								transfer_state = 594
							}
						}
						if = {
							limit = {
								country_exists = OSW
							}
							OSW = {
								transfer_state = 800
							}
						}
					}
					log = "[GetDateText]: HOR and OSW beaten [ROOT.GetName]"
					set_global_flag = skip_default_capitulation
				}
				if = {
					limit = {
						ROOT = {
							original_tag = EKW
						}
					}
					every_state = {
						limit = {
							is_claimed_by = JAS
						}
						add_core_of = JAS
					}
				}
				if = {
					limit = {
						ROOT = {
							original_tag = GDA
						}
					}
					every_controlled_state = {
						limit = {
							is_claimed_by = GDA
						}
						add_claim_by = FROM
					}
				}
			if = {
					limit = {
						ROOT = {
							original_tag = TOU
						}
						FROM = {
							OR = {
								original_tag = EKS
								original_tag = KGH
							}
						}
					}

					FROM = {
						white_peace = ROOT
						if = { limit = { country_exists = EKS } 
							annex_country = {
							target = TOU
							transfer_troops = yes
							}
						}
						if = { limit = { country_exists = KGH } 
							annex_country = {
							target = TOU
							transfer_troops = yes
							}
						}
						TOU = {
							transfer_state = 728
							transfer_state = 401
							transfer_state = 407
						}
					}
					log = "[GetDateText]: Touristenkrieg ended"
					set_global_flag = skip_default_capitulation
			}
			if = {
				limit = {
					FROM = {
						or = {
							original_tag = GNI
							original_tag = KLO
								#has_country_flag = KLO_agreed_to_join_GNI
						}
					}
					KLO = {
						has_country_flag = KLO_agreed_to_join_GNI
					}
					ROOT = {
						original_tag = KNN
					}
				}

				KLO = {
					transfer_state = 912
				}
				GNI = {
					diplomatic_relation = {
						country = KLO
						relation = puppet
						active = yes
					}
					annex_country = {
						target = KNN
						transfer_troops = no
					}
				}
				log = "koń zwalony"
				set_global_flag = skip_default_capitulation
			}
			if = {
				limit = {
					FROM = {
						original_tag = GNI
					}
					ROOT = {
						original_tag = KLO
					}
				}
				annex_country = {
					target = ROOT
					transfer_troops = no
				}
				FROM = {
					add_ideas = GNI_angry_nobles
				}
				set_global_flag = skip_default_capitulation
			}
			if = {
				limit = {
					FROM = {
						original_tag = KNN
					}
					ROOT = {
						original_tag = GNI
					}
				}
				ROOT = {
					white_peace = KNN
					white_peace = KLO
				}
				GNI_przemysł_iii = {
					retire = yes
				}
				KNN = {
					KNN_danielewski = {
						set_nationality = GNI
						promote_character = yes
						set_character_name = "Mieszko IV"
					}
				}				
				GNI = {
					create_faction = "Drużyny Piastowskie"
					add_to_faction = KLO
					add_to_faction = KNN
				}
				set_global_flag = skip_default_capitulation
			}
			if = {
					limit = {
						ROOT = {
							original_tag = KES
						}
						FROM = {
							OR = {
								original_tag = CAL
								original_tag = FEL
							}
						}
					}

					FROM = {
						white_peace = ROOT
						CAL = {
							transfer_state = 342
							transfer_state = 359
							transfer_state = 337
							transfer_state = 335
							transfer_state = 311
							transfer_state = 851
							transfer_state = 285
							transfer_state = 846
						}
						FEL = {
							transfer_state = 257
							transfer_state = 843
							transfer_state = 271
							diplomatic_relation = {
								country = LIS
								relation = puppet
								active = yes
							}
						}
						LIS = {
							transfer_state = 320	
							transfer_state = 298
							transfer_state = 274
							transfer_state = 292
							set_politics = {
								ruling_party = squattism
								}
							set_popularities = {
								marxism_cranism	= 0
								squattism = 74
								socialdemocrature = 0
								euroliberalism = 0
								freemarketism = 0
								paternal_conservatism = 0
								autocracy = 0
								corporativism = 0
								neonationalism = 0
								reactionary = 26
								postpolonism = 0
							}
						}
					}
					log = "[GetDateText]: Kesselring ded"
					set_global_flag = skip_default_capitulation
				}
				if = {
					limit = {
						ROOT = {
							original_tag = KES
						}
						FROM = {
							original_tag = LIS
						}
					}

					FROM = {
						white_peace = ROOT
						CAL = {
							transfer_state = 342
							transfer_state = 359
							transfer_state = 337
						}
						LIS = {
							transfer_state = 320	
							transfer_state = 298
							transfer_state = 274
							transfer_state = 292
							set_politics = {
								ruling_party = squattism
								}
							set_popularities = {
								marxism_cranism	= 0
								squattism = 74
								socialdemocrature = 0
								euroliberalism = 0
								freemarketism = 0
								paternal_conservatism = 0
								autocracy = 0
								corporativism = 0
								neonationalism = 0
								reactionary = 26
								postpolonism = 0
							}
						}
					}
					log = "[GetDateText]: Kesselring ded"
					set_global_flag = skip_default_capitulation
				}
			if = {
				limit = {
					ROOT = {
						original_tag = GFL
					}
					FROM = {
						original_tag = ZHP
					}
				}
				FROM = {
					country_event = {
						id = zhp.21
					}
				}
				log = "[GetDateText]: ZHP whacked greys"
			}
			if = {
				limit = {
					ROOT = {
						original_tag = ZHP
					}
					FROM = {
						original_tag = GFL
					}
					all_other_country = {
						not = {
							original_tag = GFL
						}
						not = {
							has_war_with = ROOT
						}
					}
				}
				ZHP_return_characters = yes
				ROOT = {
					white_peace = FROM
					annex_country = {
						target = FROM
						transfer_troops = yes
					}
				}
				set_politics = {
					ruling_party = postpolonism
				}
				set_country_leader_ideology = scout_system_subtype
				set_global_flag = ZHP_civil_war_lost
				set_global_flag = skip_default_capitulation
				log = "[GetDateText]: ZHP lost to greys"
			}
			if = {
				limit = {
					ROOT = {
						original_tag = ZHP
					}
					FROM = {
						original_tag = ZHR
					}
					all_other_country = {
						not = {
							original_tag = ZHR
						}
						not = {
							has_war_with = ROOT
						}
					}
				}
				ZHP_return_characters = yes
				ROOT = {
					white_peace = FROM
					annex_country = {
						target = FROM
						transfer_troops = yes
					}
				}
				set_politics = {
					ruling_party = paternal_conservatism
				}
				set_country_leader_ideology = paternal_conservatism_subtype
				set_global_flag = ZHP_civil_war_lost
				set_global_flag = skip_default_capitulation
				log = "[GetDateText]: ZHP lost to archbishop"
			}
			
			if = {	
				limit = {
					OR = {
						ROOT = { is_in_faction = no }
						ROOT = {
							all_allied_country = {
								has_capitulated = yes
							}
						}
					}
				}
				if = {
					limit = {
						FROM = {
							original_tag = BBW
						}
					}
					clear_array = global.capped_states
				}
				every_country = {
					limit = {
						is_in_faction_with = ROOT
					}
					leave_faction = YES
				}
				FROM = {
					log = "[GetDateText]: Before: [?ROOT.num_owned_states]"
					every_controlled_state = {
						limit = {
							is_owned_by = ROOT
						}
						if = {
							limit = {
								FROM = {
									original_tag = BBW
								}
							}
							add_to_array = { global.capped_states = THIS }
						}
						transfer_state_to = FROM
					}
					log = "[GetDateText]: [FROM.GetName] takes states from [ROOT.GetName]"
					every_other_country = {
						limit = {
							has_war_together_with = FROM
						}
						every_controlled_state = {
							limit = {
								is_owned_by = ROOT
							}
							transfer_state_to = PREV
						}
						log = "[GetDateText]: [THIS.GetName] (figthing together with [FROM.GetName]) takes states from [ROOT.GetName]"
					}
					every_other_country = {
						limit = {
							has_war_with = ROOT
						}
						every_controlled_state = {
							limit = {
								is_owned_by = ROOT
							}
							transfer_state_to = PREV
						}
						log = "[GetDateText]: [THIS.GetName] takes states from [ROOT.GetName]"
					}
					log = "[GetDateText]: [FROM.GetName] killed [ROOT.GetName]"
					log = "[GetDateText]: After: [?ROOT.num_owned_states] (controlled [?ROOT.num_of_controlled_states])"
					if = {
						limit = {
							or = {
								ROOT = {
									num_of_controlled_states > 0
								}
								ROOT = {
									check_variable = {
										num_owned_states > 0
									}
								}
							}
						}
						log = "[GetDateText]: [ROOT.GetName] refuse to die!"
						annex_country = {
							target = ROOT
							transfer_troops = no
						}
					}
					if = {
						limit = {
							FROM = {
								or = {
									original_tag = EKS
									original_tag = EKW
									original_tag = KGH
									original_tag = ZUL
									original_tag = WRO
									original_tag = WRT
									original_tag = KAM
									original_tag = STE
									original_tag = GDA
									original_tag = KSZ
									original_tag = LEH
									original_tag = MNI
									original_tag = POZ
									original_tag = PRK
								}
							}
						}
						every_owned_state = {
							limit = {
								is_claimed_by = FROM
								NOT = {
									is_core_of = FROM
								}
							}
							add_core_of = FROM
						}
					}
					if = {
						limit = {
							ROOT = {
								or = {
									original_tag = EKS
									original_tag = EKW
									original_tag = KGH
									original_tag = ZUL
									original_tag = WRO
									original_tag = WRT
									original_tag = KAM
									original_tag = STE
									original_tag = GDA
									original_tag = KSZ
									original_tag = LEH
									original_tag = MNI
									original_tag = POZ
									original_tag = PRK
								}
							}
						}
						every_state = {
							limit = {
								is_claimed_by = ROOT
							}
							add_core_of = ROOT
						}
					}
					#white_peace = ROOT
					#annex_country = {
						#target = ROOT
						#transfer_troops = no
					#}
				}
				set_global_flag = war_won
				set_global_flag = skip_default_capitulation
			}
			
			if = {
				limit = {
					FROM = {
						original_tag = BBW
					}
				}
				FROM = {
					country_event = {
						id = belchatow.9001
						days = 7
					}
				}
			}
			if = {
				limit = {
					FROM = {
						original_tag = ATM
					}
					ROOT = {
						original_tag = BBW
					}
				}
				FROM = {
					multiply_variable = {
						emergency_workshops = -1
					}
					add_offsite_building = {
						type = arms_factory
						level = emergency_workshops
					}
					set_country_flag = unified_voivodeship
					hidden_effect = {
						add_dynamic_modifier = {
							modifier = developed_economy_modifier
						}
						add_ideas = administrative_strain
						set_technology = {
							public_services = 1
						}
					}
					set_global_flag = lodzkie_unified
					add_research_slot = 1
					every_country = {
						limit = { NOT = { is_ai = yes } }
						news_event = { id = unification.156 }
					}
					remove_ideas = ATM_consortium_supplies
					load_focus_tree = ATM_focus_final
					set_capital = { state = 302 }
				}
				580 = {
					transfer_state_to = ZON
				}
			}
			if = { #przypadek, gdy tag nie skończył jeszcze innych wojen
				limit = {
					FROM = {
						has_war = yes
						NOT = {
							original_tag = ROS
							original_tag = UPA
							original_tag = UHR
						}
					}
				}
				log = "[FROM.GetName] is still at war! ([?FROM.casualties_k])"
				subtract_from_variable = {
					global.deadPolacksFromPastWars = FROM.casualties_k
				}
				
			}
			for_each_scope_loop = {
				array = global.allies
				if = {
					limit = {
						has_war = yes
						NOT = {
							original_tag = ROS
							original_tag = UPA
							original_tag = UHR
						}
					}
					log = "Ally [THIS.GetName] is still at war! ([?THIS.casualties_k])"
					subtract_from_variable = {
						global.deadPolacksFromPastWars = THIS.casualties_k
					}
					remove_from_array = {global.allies = THIS}
				}
			}
			if = {
				limit = {
					ROOT = {
						has_idea = barbarians_idea
					}
				}
				if = {
					limit = {
						has_character = JOM_halfdan_sandbjerg
					}
					JOM_halfdan_sandbjerg = {
						set_nationality = JOM
					}
				}
				#todo: oddawanie dla reszty barbarzyńców
			}
		}
	}
}
